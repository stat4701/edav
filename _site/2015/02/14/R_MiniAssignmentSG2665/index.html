
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7 ie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8 ie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9 ie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title>Sam Guleff Mini Assignment</title>
	<meta name="author" content="Michael Malecki">
	<link href='/assets/themes/the-minimum/css/style.css' rel="stylesheet" media="all">
	<link href="http://feeds.feedburner.com/" rel="alternate" title="Sam Guleff Mini Assignment" type="application/atom+xml">
	<script src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js"></script>
</head>
<body>

<div id="page" class="hentry">
	<header class="the-header">
		<div class="unit-head">
			<div class="unit-inner unit-head-inner">
				<p class="logo"><a href="/">EDAV</a></p>
				<nav class="nav-global">
					<ul>
						<li class="blog"><a href='archive.html'>blog &amp; slides</a></li>
						<li class="agenda"><a href='http://github.com/stat4701/edav/blob/gh-pages/agenda.md'>agenda</a></li>
						<li class="category"><a href='categories.html'>categories</a></li>
						<li class="tag"><a href='tags.html'>tags</a></li>
					</ul>
				</nav>
			</div><!-- unit-inner -->
		</div><!-- unit-head -->
	</header>
	<div class="body" role="main">
		<div class="unit-body">
			<div class="unit-inner unit-body-inner">
				<div class="entry-content">
					
<article class="unit-article layout-post">
	<div class="unit-inner unit-article-inner">
		<div class="content">
			<header>
				<div class="unit-head">
					<div class="unit-inner unit-head-inner">
						<h1 class="h2 entry-title">Sam Guleff Mini Assignment</h1>
					</div><!-- unit-inner -->
				</div><!-- unit-head -->
			</header>

			<div class="bd">
				<div class="entry-content">
					<h1>NYC Accident Data Preliminary Analysis</h1>

<h3>Concept:</h3>

<p>Starting with a cleaned version of NYPD&#39;s Crash Data which can be obtained at <a href="http://nypd.openscrape.com/#/">NYPD Crash Data Band-Aid</a>.  I wanted to determine the most accident prone locations within the 300,000 sample data set and plot onto a map of each of the 5 boroughs.  I also started looking at most dangerous pedestrian intersections around New York and Columbia University specifically.  Also, I started playing with overlaying a bin map with a few types of bins (cyclists and pedestrians killed, and a variety of primary causes of accidents).  Lastly, I wanted to plot a density of accidents map which I believe would be proportional to the traffic density, however I was unable to correlate that as average traffic density in New York is difficult to find.</p>

<h3>Libraries Used:</h3>

<p><a href="http://cran.r-project.org/web/packages/ggmap/index.html">ggmap</a> - allows for the easy visualization of spatial data and models on top of Google Maps, OpenStreetMaps, Stamen Maps, or CloudMade Maps using ggplot2.</p>

<p><a href="http://cran.r-project.org/web/packages/sqldf/index.html">SQLDF</a> - Manipulate R data frames using SQL. Being more comfortable with SQL queries I wanted a package to manipulate the data.</p>

<h3>Commented Code:</h3>
<div class="highlight"><pre><code class="language-text" data-lang="text">#Sam Guleff SG2665
#EDAV mini Assignment #1


#load all the libraries needed 
library(ggmap)
library(sqldf)


#functions -------------------------------------------------------------------------------------------


#takes data and returns new size limited dataframe aggregated by lat,long and ordered by a column
AggregateData &lt;- function(DATA, orderByCol, maxValues)
{
  tmp &lt;- paste(sep=&quot;&quot;, &quot;SELECT lon,lat,sum(&quot;,orderByCol,&quot;) as agg_&quot;,orderByCol, &quot; FROM DATA where lon &lt;&gt; &#39;&#39; and lat &lt;&gt; &#39;&#39; GROUP BY lon,lat order by agg_&quot;,orderByCol, &quot; desc limit &quot;, as.character(maxValues))
  return(sqldf(tmp))
}

#takes data and returns new size limited dataframe aggregated by lat, long and ordered by a column where at least 1 cyclists_injured, cyclists_killed, pedestr_killed, pedestr_injured 
AggregateDataPedCyc &lt;- function(DATA, orderByCol, maxValues)
{
  tmp &lt;- paste(sep=&quot;&quot;, &quot;SELECT lon,lat, SUM(cyclists_injured + cyclists_killed + pedestr_killed + pedestr_injured) as agg_&quot;,orderByCol, &quot; FROM DATA where (cyclists_injured + cyclists_killed + pedestr_killed + pedestr_injured) &gt; 0 and lon &lt;&gt; &#39;&#39; and lat &lt;&gt; &#39;&#39; GROUP BY lon,lat HAVING agg_&quot;, orderByCol,&quot; &gt; 10 order by agg_&quot;, orderByCol, &quot; desc limit &quot;, as.character(maxValues))
  return(sqldf(tmp))
}


#takes aggregated data and requires 3 fiels lon, lat and agg_collisions to plot 
plotPointMap &lt;- function(plotData, zoomLevel,  pointSize, pointAlpha, LocationCenter, chartTitle = &quot;&quot;)
{
  ZOOM_LEVEL &lt;&lt;- zoomLevel
  #plot the hybrid Google Maps basemap with points on top
  map &lt;- qmap(LocationCenter, zoom = ZOOM_LEVEL, legend = &quot;topleft&quot;)
  #map + geom_point(data = colLocations, aes(x =  as.numeric(as.character(lon)), y =  as.numeric(as.character(lat)), color=total_killed), size=GEOMPT_SIZE, alpha=GEOM_ALPHA)
  map + geom_point(data = plotData, aes(x =  as.numeric(as.character(lon)), y = as.numeric(as.character(lat)), color=agg_collisions), size=pointSize, alpha=pointAlpha) +  scale_colour_gradient(low=&quot;blue&quot;,high=&quot;red&quot;) + ggtitle(chartTitle)
}

#plot a bin map based on pedestrian and cyclist
plotDeathBinMap &lt;- function(plotData, LocationCenter, zoomLevel, binNumber,  chartTitle = &quot;&quot;)
{
  ZOOM_LEVEL &lt;&lt;- zoomLevel

  #select only deaths
  SelectBins &lt;- &quot;SELECT lon,lat, CASE 
  WHEN cyclists_killed &gt; 0 THEN \&quot;cyclists killed\&quot; 
  WHEN pedestr_killed &gt; 0  THEN \&quot;pedestr killed\&quot; 
  ELSE \&quot;None\&quot; END as Injury_Type FROM Allcollisions&quot;
  binSetFull &lt;- sqldf(SelectBins)

  #remove the none cases
  SelectRemoveNone &lt;- &quot;SELECT lon,lat, Injury_Type FROM binSetFull WHERE Injury_Type &lt;&gt; \&quot;None\&quot; &quot;
  binMapFiltered &lt;- sqldf(SelectRemoveNone)

  #bin types
  binMapFiltered$Injury_Type &lt;- factor(binMapFiltered$Injury_Type, levels = c(&quot;cyclists killed&quot;, &quot;pedestr killed&quot;)) #, &quot;cyclists injured&quot;, &quot;pedestr injured&quot;

  #map code below
  geo &lt;- stat_bin2d(
    aes(x = as.numeric(as.character(lon)), y = as.numeric(as.character(lat)), colour = Injury_Type, fill = Injury_Type),
    size = .5, bins = 60, alpha = 1/2,
    data = binMapFiltered)

  map &lt;- qmap(LocationCenter, zoom = ZOOM_LEVEL, legend = &quot;topleft&quot;) + ggtitle(chartTitle)

  map + geo 

}

#plot alternate ways to bin the data
plotAltBinMap &lt;- function(plotData, LocationCenter, zoomLevel, binNumber,  chartTitle = &quot;&quot;)
{
  ZOOM_LEVEL &lt;&lt;- zoomLevel

  #select bins
  SelectBins &lt;- &quot;SELECT lon,lat, CASE 
  WHEN aggressive_driving_road_rage &gt; 0 THEN \&quot;Road Rage\&quot; 
  WHEN cell_phone_hand_held &gt; 0  THEN \&quot;Cell Use\&quot; 
  WHEN texting &gt; 0  THEN \&quot;Text\&quot; 
  WHEN unsafe_speed &gt; 0  THEN \&quot;Unsafe Speed\&quot; 

  ELSE \&quot;None\&quot; END as Injury_Type FROM Allcollisions&quot;
  binSetFull &lt;- sqldf(SelectBins)

  #remove the none cases
  SelectRemoveNone &lt;- &quot;SELECT lon,lat, Injury_Type FROM binSetFull WHERE Injury_Type &lt;&gt; \&quot;None\&quot; &quot;
  binMapFiltered &lt;- sqldf(SelectRemoveNone)

  #bin types
  binMapFiltered$Injury_Type &lt;- factor(binMapFiltered$Injury_Type, levels = c(&quot;Road Rage&quot;, &quot;Cell Use&quot;,&quot;Text&quot;,&quot;Unsafe Speed&quot;)) #, &quot;cyclists injured&quot;, &quot;pedestr injured&quot;

  #map code below
  geo &lt;- stat_bin2d(
    aes(x = as.numeric(as.character(lon)), y = as.numeric(as.character(lat)), colour = Injury_Type, fill = Injury_Type),
    size = .5, bins = 60, alpha = 1/2,
    data = binMapFiltered)

  map &lt;- qmap(LocationCenter, zoom = ZOOM_LEVEL, legend = &quot;topleft&quot;) + ggtitle(chartTitle)

  map + geo 

}

#plot a density map of killed and injured pedestrians
plotDensityMap &lt;- function(plotData, LocationCenter, zoomLevel, binNumber,  chartTitle = &quot;&quot;)
{
  ZOOM_LEVEL &lt;&lt;- zoomLevel

  #select only deaths
  SelectBins  &lt;- &quot;SELECT lon,lat, CASE 
  WHEN cyclists_killed &gt; 0 THEN \&quot;cyclists killed\&quot; 
  WHEN pedestr_killed &gt; 0  THEN \&quot;pedestr killed\&quot; 
  WHEN cyclists_injured &gt; 0  THEN \&quot;cyclists injured\&quot; 
  WHEN pedestr_injured &gt; 0  THEN \&quot;pedestr injured\&quot; 
  ELSE \&quot;None\&quot; END as Injury_Type FROM Allcollisions&quot;
  binSetFull &lt;- sqldf(SelectBins)

  #remove the none cases
  SelectRemoveNone&lt;- &quot;SELECT lon,lat, Injury_Type FROM z WHERE Injury_Type &lt;&gt; \&quot;None\&quot; &quot;
  binMapFiltered &lt;- sqldf(SelectRemoveNone)

  #bin types and convert lon,lat to num
  z$Injury_Type &lt;- factor(z$Injury_Type, levels = c(&quot;cyclists killed&quot;, &quot;pedestr killed&quot;,&quot;pedestr injured&quot;,&quot;cyclists injured&quot;)) #, &quot;cyclists injured&quot;, &quot;pedestr injured&quot;
  z$lon &lt;- as.numeric(as.character(z$lon))
  z$lat &lt;- as.numeric(as.character(z$lat)) 

  #map code below
  geo &lt;- stat_density2d(
    aes(x = as.numeric(as.character(lon)), y = as.numeric(as.character(lat)), alpha = ..level.., fill = ..level..),
    size = .5, bins = 6, alpha = 1/2,
    data = z, geom = &quot;polygon&quot;)

  map &lt;- qmap(LocationCenter, zoom = ZOOM_LEVEL, legend = &quot;topleft&quot;) + ggtitle(chartTitle)

  map + geo

}






#Main Code Below -----------------------------------------------------------------------------------

# Set working directory
setwd(&quot;Y:/CloudStation/1 TextBooks and Notes/Data Visualization/Homework/&quot;)

#parameters for filtering and mapping
MAX_SAMPLES = 1000
LON_ROUND = 4 #factor to round long locations together 4 -&gt; .001 ~70.5ft bucket assuming 24,000 miles per LoN
LAT_ROUND = 3 #factor to round long locations together 3 -&gt; .001 ~352ft bucket assuming 12,000 miles @ 40N
ZOOM_LEVEL = 15
GEOMPT_SIZE = 6
GEOM_ALPHA = .9


#don&#39;t reread 44Megs of data is already loaded
if (!exists(&quot;Allcollisions&quot;))
{
  Allcollisions &lt;- read.delim(&quot;collisions.csv&quot;, dec=&quot;,&quot;)
}


#find most collisions and plot top 1000
clgroup &lt;- AggregateData(Allcollisions, &quot;collisions&quot; , 100000)
plotPointMap(clgroup, 15,  GEOMPT_SIZE, GEOM_ALPHA, &quot;Columbia University, New York&quot;, &quot;Most accident prone intersections near Columbia&quot;)

clgroup &lt;- AggregateData(Allcollisions, &quot;collisions&quot; , 1000)
plotPointMap(clgroup, 15, GEOMPT_SIZE, GEOM_ALPHA, &quot;Times Square, New York&quot;, &quot;TOP Accident Locations near Midtown&quot;)
plotPointMap(clgroup, 13, GEOMPT_SIZE, GEOM_ALPHA, &quot;Brooklyn, New York&quot;, &quot;TOP Accident Locations near Brooklyn&quot;)
plotPointMap(clgroup, 13,  GEOMPT_SIZE, GEOM_ALPHA, &quot;Queens, New York&quot;, &quot;TOP Accident Locations near Queens&quot;)
plotPointMap(clgroup, 13, GEOMPT_SIZE, GEOM_ALPHA, &quot;Bronx, New York&quot;, &quot;TOP Accidents Location near The Bronx&quot;)
plotPointMap(clgroup, 13, GEOMPT_SIZE, GEOM_ALPHA, &quot;Staten Island, New York&quot;, &quot;TOP Accident Locations near Staten Island&quot;)

#data on ped + cyc accidents only
clgroup &lt;- AggregateDataPedCyc(Allcollisions, &quot;collisions&quot; , 300000)
plotPointMap(clgroup, 15,  GEOMPT_SIZE, GEOM_ALPHA, &quot;Columbia University, New York&quot;, &quot;Most Dangerous Pedestrian Intersections near Columbia&quot;)
plotPointMap(clgroup, 12, 3, GEOM_ALPHA, &quot;Times Square, New York&quot;, &quot;Most Dangerous Pedestrian Intersections around NYC&quot;)


#data bined into cyclist and pedestrian deaths
plotDeathBinMap(Allcollisions, &quot;Times Square, New York&quot;, 12, 60, &quot;Deadly Pedestrian Accidents&quot;)

#density plot of all pedestrian accidents
plotDensityMap(Allcollisions, &quot;Times Square, New York&quot;, 11, 6,  chartTitle = &quot;Density of Pedestrian Accidents&quot;)

#alternate binning of data
plotAltBinMap(Allcollisions, &quot;Times Square, New York&quot;, 12, 60, &quot;Potential Causes of Accidents&quot;)
</code></pre></div>
<h3>Results:</h3>

<p><strong>Aggregated 5 years of traffic accidents showing most likely locations of accidents within neighborhoods or boroughs.</strong></p>

<p><img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accColumbia.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accMidtown.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accBrooklyn.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accQueens.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accBronx.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_accStatenIsland.png" alt=""></p>

<p><strong>Aggregated 5 years of traffic accidents showing pedestrian &amp; cyclist accidents within neighborhoods or boroughs.</strong>
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_pedColumbia.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_pedNYC.png" alt=""></p>

<p><strong>Bins on map showing where deadly accidents have occurred by pedestrian &amp; cyclist.</strong>
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_deathbin.png" alt=""></p>

<p><strong>Attempt to plot accident density overlaied onto New York City map.</strong>
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_densityplot.png" alt=""></p>

<p><strong>Bins on map showing possible causes of accidents</strong>
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_altbin1.png" alt="">
<img src="https://raw.githubusercontent.com/sguleff/edav/assignmentbranch/_posts/sguleff/sg2665_altbin2.png" alt=""></p>

<p><strong>Time Lapse and 3D Map</strong>
<a href="http://youtu.be/bNzFT5QjUys">Data Time Lapse Video and 3D Map Sample</a></p>

<h3>Difficulties and Issues:</h3>

<ul>
<li>Strange issue with variables and functions.  Likely relating to environment (namespace) </li>
<li>Binning proved difficult to plot and took longer to munge into the proper format for bin and density graphs</li>
<li>Would like to clean up functions to better handle sorting, filtering, grouping to make further analysis cleaner and easier.</li>
</ul>

					<div class="meta">
						<p class="date-publish">
							Published: 
							<date class="date-pub" title="2015-02-14T00:00:00-05:00" datetime="2015-02-14T00:00:00-05:00" pubdate>
							<span class="month"><abbr>February</abbr></span>
							<span class="day">14</span>
							<span class="year">2015</span>
							</date>
						</p>
						<ul class="list-category list-linear">
							<li class="list-head">category: </li>
							
							


  
    
  


						</ul>
						<ul class="list-tag list-linear">
							<li class="list-head">tags: </li>
							
							


  
     
    	<li><a href="/tags.html#assignments,-ref">assignments, <span>4</span></a></li>
     
    	<li><a href="/tags.html#Sam-ref">Sam <span>5</span></a></li>
     
    	<li><a href="/tags.html#Guleff-ref">Guleff <span>1</span></a></li>
    
  



						</ul>
					</div><!-- meta -->
				</div><!-- entry-content -->
				<div class="misc-content">
					<div class="social">
						<ul class="list-linear">
							<li><div class="twitter-tweet"><a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="mike_malecki" data-lang="en">Tweet</a></div></li>
							<li><div class="twitter-follow"><a href="https://twitter.com/mike_malecki" class="twitter-follow-button" data-show-count="false" data-lang="en"></a></div></li>
						</ul>
					</div>
					
					
				</div><!-- misc-content -->
				
			</div><!-- bd -->
			<footer class="unit-foot">
				<div class="unit-inner unit-foot-inner">
					<nav class="pagination">
						<ul>
							
							<li class="prev"><a class="internal" rel="prev"  href="/2015/02/12/mini-assignment" title="View mini-assignment">&laquo; mini-assignment</a></li>
							
							
							<li class="pipe"> | </li>
							
							
							<li class="next"><a class="internal" rel="next"  href="/2015/02/15/ggplot-with-R-talk" title="View Ggplot With R Talk">Ggplot With R Talk &raquo;</a></li>
							
						</ul>
					</nav>
					<p class="gotop">
						<a href="#page">Back to Top</a>
					</p>
				</div>
			</footer>

		</div><!-- content -->
	</div><!-- unit-inner -->
</article>


				</div>
			</div><!-- unit-inner -->
		</div><!-- unit-body -->
	</div><!-- body -->
	<footer class="the-footer">
		<div class="unit-foot">
			<div class="unit-inner unit-foot-inner">
				<div class="misc vcard">
					<h4>about</h4>
					<ul>
						<li class="contact"><address><span class="author fn n">Michael Malecki</span> - <span class="fn email">malecki@gmail.com</span></address></li>
						<li class="github"><a href="http://github.com/malecki/" rel="me">github.com/malecki</a></li>
						<li class="twitter"><a href="http://twitter.com/mike_malecki/" rel="me">twitter.com/mike_malecki</a></li>
						<li class="rss"><a href="http://feeds.feedburner.com/">Subscribe to RSS Feed</a></li>
					</ul>
				</div><!-- misc -->
				<p class="licence">
					Theme: <a href="http://layouts-the.me">the_minimum</a> based on <a href="http://jekyllbootstrap.com/">Jekyll-bootstrap</a>.<br>
					Powered by <a href="https://github.com/mojombo/jekyll">Jekyll</a>.
				</p>
			</div><!-- unit-foot-inner -->
		</div><!-- unit-foot -->
	</footer>
</div><!-- page -->
<script>
	(function(d, s) {
		var js, fjs = d.getElementsByTagName(s)[0], load = function(url, id) {
		if (d.getElementById(id)) {return;}
		js = d.createElement(s); js.src = url; js.id = id;
		fjs.parentNode.insertBefore(js, fjs);
		};
	load('//platform.twitter.com/widgets.js', 'tweetjs');
	// load('https://apis.google.com/js/plusone.js', 'gplus1js'); // Checkout http://j.mp/ApDgMr for usage html for this is <div class="g-plusone" data-size="medium"></div>
	// load('//connect.facebook.net/en_US/all.js#xfbml=1', 'fbjssdk'); // Checkout http://j.mp/wZw2xR for using open graph protorol html for this is <div class="fb-like" data-href="/2015/02/14/R_MiniAssignmentSG2665" data-send="false" data-layout="button_count" data-width="450" data-show-faces="false" data-font="verdana"></div>
	}(document, 'script'));
</script>
<script>
/*! A fix for the iOS orientationchange zoom bug.Script by @scottjehl, rebound by @wilto. MIT License.*/
(function(j){var i=j.document;if(!i.querySelectorAll){return}var l=i.querySelectorAll("meta[name=viewport]")[0],a=l&&l.getAttribute("content"),h=a+", maximum-scale=1.0",d=a+", maximum-scale=10.0",g=true,c=j.orientation,k=0;if(!l){return}function f(){l.setAttribute("content",d);g=true}function b(){l.setAttribute("content",h);g=false}function e(m){c=Math.abs(j.orientation);k=Math.abs(m.gamma);if(k>8&&c===0){if(g){b()}}else{if(!g){f()}}}j.addEventListener("orientationchange",f,false);j.addEventListener("deviceorientation",e,false)})(this);
</script>

  
</body>
</html>

